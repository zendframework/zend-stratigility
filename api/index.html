<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="shortcut icon" href="../img/favicon.ico">

    <title>API Reference - zend-stratigility</title>

    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Libre+Baskerville:400,400italic,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/zf-web.css" rel="stylesheet">
    <link href="../css/zf.css" rel="stylesheet">
    <link href="../css/prism-zf.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
              <a class="logo-link" href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Zend Framework"><img src="../img/zf-logo-mark.png" height="28" alt="Zend Framework" /></a>
              <a href="..">zend-stratigility</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../intro/">Intro</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../install/">Installation and Requirements</a>
</li>

                        
                            
<li >
    <a href="../usage/">Usage</a>
</li>

                        
                            
<li >
    <a href="../middleware/">Middleware</a>
</li>

                        
                            
<li >
    <a href="../error-handlers/">Error Handlers</a>
</li>

                        
                            
<li >
    <a href="../creating-middleware/">Creating Middleware</a>
</li>

                        
                            
<li >
    <a href="../executing-middleware/">Executing and composing middleware</a>
</li>

                        
                            
<li class="active">
    <a href="./">API Reference</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="component-toggle" data-toggle="tooltip" data-placement="bottom" title="Show component list">
                        <i class="fa fa-book"></i> Components
                    </a>
                </li>

                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li>
                        <a href="https://github.com/zendframework/zend-stratigility">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div id="page-top" class="container docs">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#api-reference">API Reference</a></li>
        
            <li><a href="#middleware">Middleware</a></li>
        
            <li><a href="#next">Next</a></li>
        
            <li><a href="#finalhandler">FinalHandler</a></li>
        
            <li><a href="#http-messages">HTTP Messages</a></li>
        
    
    </ul>

    
    <ul class="pager hidden-print">
      <li class="previous">
        <a rel="prev" href="../executing-middleware/"><i class="fa fa-arrow-left"></i> Previous</a>
      </li>
      <li class="next disabled ">
        <a rel="next" >Next <i class="fa fa-arrow-right"></i></a>
      </li>
    </ul>
    
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="..">Docs</a> &raquo;</li>
  
    
      
        <li>Reference &raquo;</li>
      
    
  
  <li class="active">API Reference</li>
</ol>

<h1 id="api-reference">API Reference</h1>
<p>The following make up the primary API of Stratigility.</p>
<h2 id="middleware">Middleware</h2>
<p><code>Zend\Stratigility\MiddlewarePipe</code> is the primary application interface, and has been discussed
previously. Its API is:</p>
<pre class="codehilite"><code class="language-php">class MiddlewarePipe implements MiddlewareInterface
{
    public function pipe(string|callable $path, callable $middleware = null);
    public function __invoke(
        Psr\Http\Message\ServerRequestInterface $request = null,
        Psr\Http\Message\ResponseInterface $response = null,
        callable $out = null
    ) :  Psr\Http\Message\ResponseInterface;
}</code></pre>


<p><code>pipe()</code> takes up to two arguments. If only one argument is provided, <code>$middleware</code> will be assigned
that value, and <code>$path</code> will be re-assigned to the value <code>/</code>; this is an indication that the
<code>$middleware</code> should be invoked for any path. If <code>$path</code> is provided, the <code>$middleware</code> will only be
executed for that path and any subpaths.</p>
<p>Middleware is executed in the order in which it is piped to the <code>MiddlewarePipe</code> instance.</p>
<p><code>__invoke()</code> is itself middleware. If <code>$out</code> is not provided, an instance of
<code>Zend\Stratigility\FinalHandler</code> will be created, and used in the event that the pipe stack is
exhausted (<code>MiddlewarePipe</code> passes the <code>$response</code> instance it receives to <code>FinalHandler</code> as well,
so that the latter can determine if the response it receives is new).</p>
<p>The callable should use the same signature as <code>Next()</code>:</p>
<pre class="codehilite"><code class="language-php">function (
    Psr\Http\Message\ServerRequestInterface $request,
    Psr\Http\Message\ResponseInterface $response,
    $err = null
) : Psr\Http\Message\ResponseInterface</code></pre>


<p>Internally, <code>MiddlewarePipe</code> creates an instance of <code>Zend\Stratigility\Next</code>, feeding it its queue,
executes it, and returns a response.</p>
<h2 id="next">Next</h2>
<p><code>Zend\Stratigility\Next</code> is primarily an implementation detail of middleware, and exists to allow
delegating to middleware registered later in the stack. It is implemented as a functor.</p>
<p>Because <code>Psr\Http\Message</code>'s interfaces are immutable, if you make changes to your Request and/or
Response instances, you will have new instances, and will need to make these known to the next
middleware in the chain. <code>Next</code> expects these arguments for every invocation. Additionally, if an
error condition has occurred, you may pass an optional third argument, <code>$err</code>, representing the
error condition.</p>
<pre class="codehilite"><code class="language-php">class Next
{
    public function __invoke(
        Psr\Http\Message\ServerRequestInterface $request,
        Psr\Http\Message\ResponseInterface $response,
        $err = null
    ) : Psr\Http\Message\ResponseInterface;
}</code></pre>


<p>You should <strong>always</strong> either capture or return the return value of <code>$next()</code> when calling it in your
application. The expected return value is a response instance, but if it is not, you may want to
return the response provided to you.</p>
<p>As examples:</p>
<h3 id="providing-an-altered-request">Providing an altered request:</h3>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next) use ($bodyParser)
{
    $bodyParams = $bodyParser($request);
    return $next(
        $request-&gt;withBodyParams($bodyParams), // Next will pass the new
        $response                              // request instance
    );
}</code></pre>


<h3 id="providing-an-altered-response">Providing an altered response:</h3>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next)
{
    $updated = $response-&gt;addHeader('Cache-Control', [
        'public',
        'max-age=18600',
        's-maxage=18600',
    ]);
    return $next($request, $updated);
}</code></pre>


<h3 id="providing-both-an-altered-request-and-response">Providing both an altered request and response:</h3>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next) use ($bodyParser)
{
    $updated = $response-&gt;addHeader('Cache-Control', [
        'public',
        'max-age=18600',
        's-maxage=18600',
    ]);
    return $next(
        $request-&gt;withBodyParams($bodyParser($request)),
        $updated
    );
}</code></pre>


<h3 id="returning-a-response-to-complete-the-request">Returning a response to complete the request</h3>
<p>If you have no changes to the response, and do not want further middleware in the pipeline to
execute, do not call <code>$next()</code> and simply return from your middleware. However, it's almost always
better and more predictable to return the response instance, as this will ensure it propagates back
up to all callers.</p>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next)
{
    $response = $response-&gt;addHeader('Cache-Control', [
        'public',
        'max-age=18600',
        's-maxage=18600',
    ]);
    return $response;
}</code></pre>


<p>One caveat: if you are in a nested middleware or not the first in the stack, all parent and/or
previous middleware must also call <code>return $next(/* ... */)</code> for this to work correctly.</p>
<p>As such, <em>we recommend always returning <code>$next()</code> when invoking it in your middleware</em>:</p>
<pre class="codehilite"><code class="language-php">return $next(/* ... */);</code></pre>


<p>And, if not calling <code>$next()</code>, returning the response instance:</p>
<pre class="codehilite"><code class="language-php">return $response;</code></pre>


<p>The <code>FinalHandler</code> implementation will check the <code>$response</code> instance passed when invoking it
against the instance passed during instantiation, and, if different, return it. As such, <code>return
$next(/* ... */)</code> is the recommended workflow.</p>
<h3 id="raising-an-error-condition">Raising an error condition</h3>
<p>To raise an error condition, pass a non-null value as the third argument to <code>$next()</code>:</p>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next)
{
    try {
        // try some operation...
    } catch (Exception $e) {
        return $next($request, $response, $e); // Next registered error middleware will be invoked
    }
}</code></pre>


<h2 id="finalhandler">FinalHandler</h2>
<p><code>Zend\Stratigility\FinalHandler</code> is a default implementation of middleware to execute when the stack
exhausts itself. It expects three arguments when invoked: a request instance, a response instance,
and an error condition (or <code>null</code> for no error). It returns a response.</p>
<p><code>FinalHandler</code> allows two optional arguments during instantiation</p>
<ul>
<li><code>$options</code>, an array of options with which to configure itself. These options currently include:</li>
<li><code>env</code>, the application environment. If set to "production", no stack traces will be provided.</li>
<li><code>onerror</code>, a callable to execute if an error is passed when <code>FinalHandler</code> is invoked. The
    callable is invoked with the error (which will be <code>null</code> in the absence of an error), the request,
    and the response, in that order.</li>
<li><code>Psr\Http\Message\ResponseInterface $response</code>; if passed, it will compare the response passed
  during invocation against this instance; if they are different, it will return the response from
  the invocation, as this indicates that one or more middleware provided a new response instance.</li>
</ul>
<p>Internally, <code>FinalHandler</code> does the following on invocation:</p>
<ul>
<li>If <code>$error</code> is non-<code>null</code>, it creates an error response from the response provided at invocation,
  ensuring a 400 or 500 series response is returned.</li>
<li>If the response at invocation matches the response provided at instantiation, it returns it
  without further changes. This is an indication that some middleware at some point in the execution
  chain called <code>$next()</code> with a new response instance.</li>
<li>If the response at invocation does not match the response provided at instantiation, or if no
  response was provided at instantiation, it creates a 404 response, as the assumption is that no
  middleware was capable of handling the request.</li>
</ul>
<h2 id="http-messages">HTTP Messages</h2>
<h3 id="zendstratigilityhttprequest">Zend\Stratigility\Http\Request</h3>
<p><code>Zend\Stratigility\Http\Request</code> acts as a decorator for a <code>Psr\Http\Message\ServerRequestInterface</code>
instance. The primary reason is to allow composing middleware such that you always have access to
the original request instance.</p>
<p>As an example, consider the following:</p>
<pre class="codehilite"><code class="language-php">$app1 = new Middleware();
$app1-&gt;pipe('/foo', $fooCallback);

$app2 = new Middleware();
$app2-&gt;pipe('/root', $app1);

$server = Server::createServer($app2 /* ... */);</code></pre>


<p>In the above, if the URI of the original incoming request is <code>/root/foo</code>, what <code>$fooCallback</code> will
receive is a URI with a past consisting of only <code>/foo</code>. This practice ensures that middleware can be
nested safely and resolve regardless of the nesting level.</p>
<p>If you want access to the full URI — for instance, to construct a fully qualified URI to your
current middleware — <code>Zend\Stratigility\Http\Request</code> contains a method, <code>getOriginalRequest()</code>,
which will always return the original request provided to the application:</p>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next)
{
    $location = $request-&gt;getOriginalRequest()-&gt;getUri()-&gt;getPath() . '/[:id]';
    $response = $response-&gt;setHeader('Location', $location);
    $response = $response-&gt;setStatus(302);
    return $response;
}</code></pre>


<h3 id="zendstratigilityhttpresponse">Zend\Stratigility\Http\Response</h3>
<p><code>Zend\Stratigility\Http\Response</code> acts as a decorator for a <code>Psr\Http\Message\ResponseInterface</code>
instance, and also implements <code>Zend\Stratigility\Http\ResponseInterface</code>, which provides the
following convenience methods:</p>
<ul>
<li><code>write()</code>, which proxies to the <code>write()</code> method of the composed response stream.</li>
<li><code>end()</code>, which marks the response as complete; it can take an optional argument, which, when
  provided, will be passed to the <code>write()</code> method. Once <code>end()</code> has been called, the response is
  immutable and will throw an exception if a state mutating method like <code>withHeader</code> is called.</li>
<li><code>isComplete()</code> indicates whether or not <code>end()</code> has been called.</li>
</ul>
<p>Additionally, it provides access to the original response created by the server via the method
<code>getOriginalResponse()</code>.</p>

<hr />


<nav>
  <ul class="pager hidden-print">
    <li class="previous">
      <a rel="prev" href="../executing-middleware/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next disabled ">
      <a rel="next" >Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>
</div>
        
    </div>
    <!-- content:end -->

    <div id="footerwrap">
    <div class="container">
        <div class="row site-map">
            <div class="col-lg-3">
              <p>
                <strong>Zend Framework</strong><br />
                <a href="http://framework.zend.com/">framework.zend.com</a><br />
                <a href="https://docs.zendframework.com">docs.zendframework.com</a><br />
                <a href="https://packages.zendframework.com">packages.zendframework.com</a><br />
                <a href="https://apigility.org">apigility.org</a><br />
              </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 centered">
                <a class="back-to-top" href="#page-top"><i class="fa fa-chevron-circle-up fa-4" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="spacing"></div>

        <div class="row">
            <div class="col-lg-8">
                <h4>Copyright</h4>
                <div class="hline-w"></div>

                <p>&copy; 2006-2016 by <a href="http://www.zend.com">Zend</a>, a <a href="http://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            <div class="col-lg-4">
                <h4>Contacts</h4>
                <div class="hline-w"></div>
                <p>
                    <a href="irc://irc.freenode.net/zftalk" class="btn-social btn-outline" alt="IRC" title="IRC"><i class="fa fa-comment"></i></a>
                    <a href="https://github.com/zendframework" class="btn-social btn-outline" alt="Github" title="Github"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/zfdevteam" class="btn-social btn-outline" alt="Twitter" title="Twitter"><i class="fa fa-twitter"></i></a>
                </p>
            </div>
        </div>
    </div>
</div>


    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    <script src="../js/prism-zf.js"></script>

    <script>var base_url = '..';</script>
    <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
    <script src="../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="zf-components">
  <div class="zf-components-grid">
    <div class="zf-logo">
      <a href="http://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../img/zf-logo-mark.png" alt="Zend Framework" width="250" /></a>
    </div>

    <div class="component-list"></div>

    <p class="zf-components-rollup"><a href="#">Hide list</a></p>
  </div>
</div>

    <script>
  // Prepare the component list dropdown for display
  $(function () {
    var components = $(".zf-components"),
        componentList = components.find(".component-list"),
        sidebar = $(".bs-sidebar.affix"),
        sidebarInitialPos = sidebar.css("position"),
        hidden,
        componentToggle = $(".component-toggle"),
        navbar = $(".navbar-fixed-top"),
        rollUpLink = $(".zf-components-rollup a");

    // Initial setup on document load
    components.insertBefore(navbar);
    $(".zf-logo a").tooltip();
    componentToggle.tooltip();
    rollUpLink.attr({ href: "#", alt: "Hide component list" });

    // Cast initial sidebar position value
    if (undefined === sidebarInitialPos) {
      sidebarInitialPos = "fixed";
    }

    // Setup onclick events to toggle list
    componentToggle.click(toggleComponentList);
    rollUpLink.click(toggleComponentList);

    // Toggle the component list display
    function toggleComponentList(event) {
      event.preventDefault();

      if (hidden === undefined) {
        // Not loaded yet; load and display.
        loadComponentList();
        return;
      }

      if (hidden) {
        // Hidden; display.
        showComponentList();
        return;
      }

      // Currently visible; hide
      hideComponentList();
    }

    // Show the component list
    function showComponentList() {
      navbar.css({position: "relative"});
      sidebar.css({position: "relative"});
      components
        .css({"margin-top": "-" + components.outerHeight() + "px"})
        .show()
        .animate({"margin-top": 0}, {
          complete: function () {
            componentToggle
              .data("placement", "top")
              .attr("data-original-title", "Hide component list");
            hidden = false;
          },
          queue: false
        });
    }

    // Hide the component list
    function hideComponentList() {
      components.animate({"margin-top": "-" + components.outerHeight() + "px"}, {
        complete: function () {
          navbar.css({position: "fixed"});
          sidebar.css({position: sidebarInitialPos});
          componentToggle
            .data("placement", "bottom")
            .attr("data-original-title", "Show component list");
          components.hide();
          hidden = true;
        },
        queue: false
      });
      sidebar.animate({ top: sidebarInitialTop + "px" }, { queue: false});
    }

    // Inject a component into the componet list DOM.
    function injectComponent(index, component) {
      componentList.append('<div class="component"><h4><a href="' + component.url + '">' + component.name + '</a></h4><p>' + component.description + '</p></div>');
    }

    // Parse the component list, build the DOM, and display it.
    function parseComponentList(components) {
      $.each(components, injectComponent);
      showComponentList();
    }

    // Fetch the component list and display it.
    function loadComponentList () {
      $.ajax({
        url: "//docs.zendframework.com/zf-mkdoc-theme/scripts/zf-component-list.json",
        dataType: "text json",
        success: parseComponentList,
        error: function (e) {
          console.log("Error occurred with XHR call", e);
        }
      });
    }
  });
</script>
    </body>

</html>
